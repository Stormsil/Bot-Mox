name: botmox-stack

services:
  caddy:
    image: caddy:2.9-alpine
    restart: unless-stopped
    depends_on:
      - frontend
      - backend
      - minio
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - edge
      - app

  frontend:
    image: ${FRONTEND_IMAGE:-bot-mox/frontend:prod-sim}
    restart: unless-stopped
    networks:
      - app

  backend:
    image: ${BACKEND_IMAGE:-bot-mox/backend:prod-sim}
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${BACKEND_PORT:-3001}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      DATA_BACKEND: ${DATA_BACKEND:-rtdb}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET_ARTIFACTS: ${S3_BUCKET_ARTIFACTS:-botmox-artifacts}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      S3_PRESIGN_TTL_SECONDS: ${S3_PRESIGN_TTL_SECONDS:-300}
      REQUIRE_S3_READY: ${REQUIRE_S3_READY:-false}
      REQUIRE_SUPABASE_READY: ${REQUIRE_SUPABASE_READY:-false}
      INTERNAL_API_TOKEN: ${INTERNAL_API_TOKEN:-}
      INTERNAL_INFRA_TOKEN: ${INTERNAL_INFRA_TOKEN:-}
      LICENSE_LEASE_SECRET: ${LICENSE_LEASE_SECRET:-}
      FIREBASE_SERVICE_ACCOUNT_PATH: ${FIREBASE_SERVICE_ACCOUNT_PATH:-}
      FIREBASE_DATABASE_URL: ${FIREBASE_DATABASE_URL:-}
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-}
    networks:
      - app

  minio:
    image: minio/minio:RELEASE.2025-07-23T15-54-02Z
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-change-me-minio-root}
    ports:
      - "${MINIO_API_BIND_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_BIND_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    networks:
      - app

  minio-init:
    image: minio/mc:RELEASE.2025-07-21T05-28-08Z
    depends_on:
      - minio
    restart: "no"
    entrypoint: >
      /bin/sh -c "
      set -eu;
      until mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD; do sleep 1; done;
      mc mb -p local/$$MINIO_BUCKET || true;
      mc anonymous set none local/$$MINIO_BUCKET || true;
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-change-me-minio-root}
      MINIO_BUCKET: ${MINIO_BUCKET:-botmox-artifacts}
    networks:
      - app

networks:
  edge:
    driver: bridge
  app:
    driver: bridge

volumes:
  caddy-data:
  caddy-config:
  minio-data:
