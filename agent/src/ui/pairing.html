<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bot-Mox Agent - Pairing</title>
  <style>
    :root {
      color-scheme: dark;
      --boxmox-color-surface-base: #1e1f22;
      --boxmox-color-surface-panel: #2a2f35;
      --boxmox-color-surface-muted: #31363d;
      --boxmox-color-surface-hover: #3a414a;
      --boxmox-color-surface-active: #444c56;
      --boxmox-color-brand-primary: #4a90d6;
      --boxmox-color-brand-primary-hover: #5aa0e0;
      --boxmox-color-brand-soft: #233a4f;
      --boxmox-color-text-primary: #e6edf3;
      --boxmox-color-text-secondary: #b9c3cd;
      --boxmox-color-text-muted: #8e9aa6;
      --boxmox-color-status-success: #2ecc71;
      --boxmox-color-status-danger: #e74c3c;
      --boxmox-color-border-default: #3a424a;
      --boxmox-color-border-strong: #23282f;
      --boxmox-color-header-bg: #1f2a33;
      --boxmox-color-header-border: #182129;
      --boxmox-color-header-text: #e6edf3;
      --boxmox-color-header-text-muted: #97a6b4;
      --boxmox-color-header-hover: #2a3945;
      --font-primary: "Roboto", "Segoe UI", sans-serif;
      --radius-sm: 2px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      min-height: 100%;
      font-family: var(--font-primary);
      color: var(--boxmox-color-text-primary);
      background: var(--boxmox-color-surface-base);
    }

    body {
      padding: 10px;
      overflow: auto;
    }

    .app-shell {
      width: min(900px, 100%);
      margin: 0 auto;
      border: 1px solid var(--boxmox-color-border-default);
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--boxmox-color-surface-panel);
      box-shadow: 0 20px 46px rgba(0, 0, 0, 0.32);
    }

    .header {
      padding: 11px 14px;
      border-bottom: 1px solid var(--boxmox-color-header-border);
      background: var(--boxmox-color-header-bg);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .title {
      margin: 0;
      font-size: 16px;
      line-height: 1.2;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: var(--boxmox-color-header-text);
    }

    .title-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border: 1px solid var(--boxmox-color-header-border);
      border-radius: var(--radius-sm);
      background: var(--boxmox-color-header-hover);
      color: var(--boxmox-color-header-text-muted);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .subtitle {
      margin: 8px 0 0;
      color: var(--boxmox-color-header-text-muted);
      font-size: 12px;
      line-height: 1.4;
      max-width: 720px;
    }

    .content {
      padding: 10px;
      display: grid;
      gap: 10px;
    }

    .section {
      border: 1px solid var(--boxmox-color-border-default);
      border-radius: var(--radius-sm);
      background: var(--boxmox-color-surface-muted);
      padding: 10px;
    }

    .section-title {
      margin: 0;
      color: var(--boxmox-color-text-primary);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .section-desc {
      margin: 7px 0 10px;
      color: var(--boxmox-color-text-muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .row {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }

    .row.two {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    label {
      display: block;
      margin-bottom: 4px;
      color: var(--boxmox-color-text-secondary);
      font-size: 12px;
      font-weight: 600;
    }

    input,
    select {
      width: 100%;
      min-height: 34px;
      border: 1px solid var(--boxmox-color-border-default);
      border-radius: var(--radius-sm);
      background: var(--boxmox-color-surface-panel);
      color: var(--boxmox-color-text-primary);
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      transition: border-color 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
    }

    input:hover,
    select:hover {
      border-color: var(--boxmox-color-border-strong);
      background: var(--boxmox-color-surface-hover);
    }

    input:focus,
    select:focus {
      border-color: var(--boxmox-color-brand-primary);
      box-shadow: 0 0 0 2px rgba(74, 144, 214, 0.22);
      background: var(--boxmox-color-surface-active);
    }

    input::placeholder {
      color: var(--boxmox-color-text-muted);
    }

    .hint {
      margin-top: 6px;
      color: var(--boxmox-color-text-muted);
      font-size: 11px;
      line-height: 1.42;
    }

    .hint.success {
      color: var(--boxmox-color-status-success);
    }

    .hint.warning {
      color: #f2c16d;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon input {
      padding-right: 44px;
    }

    .icon-btn {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 34px;
      height: 26px;
      border: 1px solid var(--boxmox-color-border-default);
      border-radius: var(--radius-sm);
      background: var(--boxmox-color-surface-panel);
      color: var(--boxmox-color-text-secondary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      transition: border-color 120ms ease, background-color 120ms ease;
    }

    .icon-btn:hover {
      border-color: var(--boxmox-color-border-strong);
      background: var(--boxmox-color-surface-hover);
    }

    .icon-btn:focus {
      outline: none;
      border-color: var(--boxmox-color-brand-primary);
      box-shadow: 0 0 0 2px rgba(74, 144, 214, 0.22);
    }

    .icon-btn svg {
      width: 14px;
      height: 14px;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .icon-btn .icon-hidden {
      display: none;
    }

    .icon-btn.is-active .icon-open {
      display: none;
    }

    .icon-btn.is-active .icon-hidden {
      display: block;
    }

    .btn {
      min-height: 34px;
      border-radius: var(--radius-sm);
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      padding: 0 12px;
      color: var(--boxmox-color-text-primary);
      background: var(--boxmox-color-surface-panel);
      border-color: var(--boxmox-color-border-default);
      transition: background-color 120ms ease, border-color 120ms ease, transform 80ms ease, filter 120ms ease;
    }

    .btn:hover {
      border-color: var(--boxmox-color-border-strong);
      background: var(--boxmox-color-surface-hover);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn.primary {
      width: 100%;
      border-color: var(--boxmox-color-brand-primary);
      background: var(--boxmox-color-brand-primary);
      color: var(--boxmox-color-text-strong, #f4f7fa);
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .btn.primary:hover {
      background: var(--boxmox-color-brand-primary-hover);
      border-color: var(--boxmox-color-brand-primary-hover);
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .target-row {
      grid-template-columns: minmax(0, 1fr) 170px;
      align-items: end;
    }

    .target-action .btn {
      width: 100%;
    }

    details.section {
      padding: 0;
      overflow: hidden;
    }

    .section-summary {
      list-style: none;
      cursor: pointer;
      padding: 10px;
      border: 1px solid transparent;
      transition: background-color 120ms ease, border-color 120ms ease;
    }

    .section-summary::-webkit-details-marker {
      display: none;
    }

    .section-summary:hover {
      background: var(--boxmox-color-surface-hover);
    }

    .section-summary:focus {
      outline: none;
      border-color: var(--boxmox-color-brand-primary);
      box-shadow: 0 0 0 2px rgba(74, 144, 214, 0.22);
    }

    .summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .summary-note {
      color: var(--boxmox-color-text-muted);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .details-content {
      border-top: 1px solid var(--boxmox-color-border-default);
      padding: 10px;
      background: var(--boxmox-color-surface-muted);
    }

    .inline-status {
      min-height: 18px;
      font-size: 12px;
      font-weight: 600;
      padding-left: 2px;
    }

    .inline-status.error {
      color: var(--boxmox-color-status-danger);
    }

    .inline-status.success {
      color: var(--boxmox-color-status-success);
    }

    @media (max-width: 700px) {
      body {
        padding: 10px;
      }

      .row.two {
        grid-template-columns: 1fr;
      }

      .target-row {
        grid-template-columns: 1fr;
      }

      .title {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="header">
      <div class="header-top">
        <h1 class="title">Bot-Mox Agent Pairing</h1>
        <div class="title-chip">Secure Pairing</div>
      </div>
      <p class="subtitle">
        Sign in with your Bot-Mox account, add a computer, and click Pair Agent.
      </p>
    </header>

    <main class="content">
      <section class="section">
        <h2 class="section-title">Bot-Mox Account</h2>
        <p class="section-desc">
          Recommended flow: sign in with your Bot-Mox account.
          Agent token is issued automatically.
        </p>

        <div class="row">
          <div>
            <label for="accountLogin">Login (Email)</label>
            <input id="accountLogin" type="text" autocomplete="username" placeholder="you@example.com" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="accountPassword">Account Password</label>
            <div class="input-with-icon">
              <input id="accountPassword" type="password" autocomplete="current-password" placeholder="Enter Bot-Mox password" />
              <button
                id="toggleAccountPasswordBtn"
                type="button"
                class="icon-btn"
                title="Toggle password visibility"
                aria-label="Show password"
              >
                <svg class="icon-open" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="icon-hidden" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M17.9 17.9A10.9 10.9 0 0 1 12 19C5 19 1 12 1 12a20 20 0 0 1 5-5.9"></path>
                  <path d="M9.9 4.2A10.9 10.9 0 0 1 12 5c7 0 11 7 11 7a20.3 20.3 0 0 1-4.1 4.8"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div class="hint">Used only for one-time automatic pairing. Not stored locally.</div>
          </div>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">Proxmox Access</h2>
        <p class="section-desc">
          Used for VM actions on this computer (clone/start/stop/delete).
        </p>

        <div class="row target-row">
          <div>
            <label for="targetSelect">Saved Computers</label>
            <select id="targetSelect">
              <option value="">Current form values</option>
            </select>
          </div>
          <div class="target-action">
            <label for="newTargetBtn">&nbsp;</label>
            <button id="newTargetBtn" type="button" class="btn">Add New Computer</button>
          </div>
        </div>
        <div class="hint">Select existing computer to edit, or click Add New Computer, fill fields, then Save Computer.</div>

        <div class="row">
          <div>
            <label for="proxmoxUrl">Proxmox URL</label>
            <input id="proxmoxUrl" type="text" placeholder="https://192.168.1.100:8006" />
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="proxmoxUsername">Username</label>
            <input id="proxmoxUsername" type="text" placeholder="root" />
          </div>
          <div>
            <label for="proxmoxNode">Node</label>
            <input id="proxmoxNode" type="text" placeholder="h1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="proxmoxPassword">Password</label>
            <div class="input-with-icon">
              <input id="proxmoxPassword" type="password" autocomplete="off" placeholder="Enter Proxmox password" />
              <button
                id="togglePasswordBtn"
                type="button"
                class="icon-btn"
                title="Toggle password visibility"
                aria-label="Show password"
              >
                <svg class="icon-open" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg class="icon-hidden" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M17.9 17.9A10.9 10.9 0 0 1 12 19C5 19 1 12 1 12a20 20 0 0 1 5-5.9"></path>
                  <path d="M9.9 4.2A10.9 10.9 0 0 1 12 5c7 0 11 7 11 7a20.3 20.3 0 0 1-4.1 4.8"></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
              </button>
            </div>
            <div id="passwordHint" class="hint">Password is stored encrypted on this device.</div>
          </div>
        </div>

        <div class="actions">
          <button id="testProxmoxBtn" type="button" class="btn">Test Proxmox Connection</button>
          <button id="saveTargetBtn" type="button" class="btn">Save Computer</button>
        </div>
      </section>

      <div class="actions">
        <button id="pairBtn" type="button" class="btn primary">Pair Agent</button>
        <div id="message" class="inline-status"></div>
      </div>
    </main>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const defaults = {
      // In docker "prod-sim" mode backend is routed behind Caddy on :80 (/api/*),
      // so the correct default is http://localhost (not :3001).
      // For dev mode without Caddy, use http://localhost:3001.
      serverUrl: 'http://localhost',
      proxmoxUrl: 'https://192.168.1.100:8006',
      proxmoxUsername: 'root',
      proxmoxNode: 'h1',
    };

    const state = {
      targetsById: {},
      activeTargetId: '',
    };

    function normalizeTargetId(value) {
      return String(value || '').trim();
    }

    function setTargets(targets, activeTargetId) {
      state.targetsById = {};
      const normalizedTargets = Array.isArray(targets) ? targets : [];
      normalizedTargets.forEach((target) => {
        const id = normalizeTargetId(target?.id);
        if (!id) return;
        state.targetsById[id] = {
          id,
          label: String(target.label || id),
          url: normalizeUrl(target.url || ''),
          username: String(target.username || '').trim(),
          node: String(target.node || '').trim() || 'h1',
          hasPassword: Boolean(target.hasPassword),
          password: String(target.password || ''),
        };
      });

      const select = $('targetSelect');
      select.innerHTML = '';

      const customOption = document.createElement('option');
      customOption.value = '';
      customOption.textContent = 'Current form values';
      select.appendChild(customOption);

      Object.values(state.targetsById).forEach((target) => {
        const option = document.createElement('option');
        option.value = target.id;
        option.textContent = target.label;
        select.appendChild(option);
      });

      const normalizedActive = normalizeTargetId(activeTargetId);
      if (normalizedActive && state.targetsById[normalizedActive]) {
        select.value = normalizedActive;
        state.activeTargetId = normalizedActive;
      } else {
        select.value = '';
        state.activeTargetId = '';
      }
    }

    function applySelectedTargetToForm(targetId) {
      const normalizedId = normalizeTargetId(targetId);
      const target = normalizedId ? state.targetsById[normalizedId] : null;
      if (!target) return false;
      $('proxmoxUrl').value = target.url || '';
      $('proxmoxUsername').value = target.username || '';
      $('proxmoxNode').value = target.node || 'h1';
      return true;
    }

    function getSelectedTargetId() {
      const value = normalizeTargetId($('targetSelect').value);
      return value || '';
    }

    function normalizeUrl(value) {
      return String(value || '').trim().replace(/\/+$/, '');
    }

    function tryParseJson(text) {
      try {
        return JSON.parse(text);
      } catch {
        return null;
      }
    }

    function decodeBase64Url(value) {
      const input = String(value || '').trim();
      if (!input) return '';
      const normalized = input.replace(/-/g, '+').replace(/_/g, '/');
      const padding = (4 - (normalized.length % 4)) % 4;
      const padded = normalized + '='.repeat(padding);
      try {
        return atob(padded);
      } catch {
        return '';
      }
    }

    function sanitizeProxmoxHints(value) {
      if (!value || typeof value !== 'object') return null;
      const url = normalizeUrl(value.url || value.proxmoxUrl || '');
      const username = String(value.username || value.proxmoxUsername || '').trim();
      const node = String(value.node || value.proxmoxNode || '').trim();

      const payload = {};
      if (url) payload.url = url;
      if (username) payload.username = username;
      if (node) payload.node = node;
      return Object.keys(payload).length > 0 ? payload : null;
    }

    function parseBundle(bundle, fallbackServerUrl) {
      const decoded = decodeBase64Url(bundle);
      if (!decoded) return null;

      const payload = tryParseJson(decoded);
      if (!payload || typeof payload !== 'object') return null;

      const pairingCode = String(payload.pairing_code || payload.code || '').trim();
      if (!pairingCode) return null;

      return {
        pairingCode,
        serverUrl: normalizeUrl(payload.server_url || payload.serverUrl || fallbackServerUrl || ''),
        proxmox: sanitizeProxmoxHints(payload.proxmox || payload.proxmox_defaults),
      };
    }

    function _parsePairingInput(rawInput, fallbackServerUrl) {
      const raw = String(rawInput || '').trim();
      const normalizedFallbackServer = normalizeUrl(fallbackServerUrl || '');

      if (!raw) {
        return { pairingCode: '', serverUrl: normalizedFallbackServer, proxmox: null };
      }

      const bundled = parseBundle(raw, normalizedFallbackServer);
      if (bundled) return bundled;

      const fromJson = tryParseJson(raw);
      if (fromJson && typeof fromJson === 'object') {
        const pairingCode = String(fromJson.pairing_code || fromJson.code || '').trim();
        if (pairingCode) {
          return {
            pairingCode,
            serverUrl: normalizeUrl(fromJson.server_url || fromJson.serverUrl || normalizedFallbackServer),
            proxmox: sanitizeProxmoxHints(fromJson.proxmox || fromJson.proxmox_defaults),
          };
        }
      }

      if (raw.includes('://')) {
        try {
          const parsedUrl = new URL(raw);
          const bundleFromQuery = parsedUrl.searchParams.get('bundle');
          if (bundleFromQuery) {
            const fromBundle = parseBundle(bundleFromQuery, parsedUrl.origin || normalizedFallbackServer);
            if (fromBundle) {
              return {
                pairingCode: fromBundle.pairingCode,
                serverUrl: fromBundle.serverUrl || normalizeUrl(parsedUrl.origin || normalizedFallbackServer),
                proxmox: fromBundle.proxmox || null,
              };
            }
          }

          const pairingCodeFromQuery = String(
            parsedUrl.searchParams.get('pairing_code') || parsedUrl.searchParams.get('code') || ''
          ).trim();
          const pathChunks = parsedUrl.pathname.split('/').filter(Boolean);
          const pairingCodeFromPath = pathChunks.length >= 2 && pathChunks[pathChunks.length - 2] === 'pair'
            ? String(pathChunks[pathChunks.length - 1] || '').trim()
            : '';
          const pairingCode = pairingCodeFromQuery || pairingCodeFromPath;

          if (pairingCode) {
            let serverUrl = normalizeUrl(
              parsedUrl.searchParams.get('server_url') || parsedUrl.searchParams.get('serverUrl') || ''
            );
            if (!serverUrl && /^https?:$/i.test(parsedUrl.protocol)) {
              serverUrl = normalizeUrl(parsedUrl.origin);
            }

            return {
              pairingCode,
              serverUrl: serverUrl || normalizedFallbackServer,
              proxmox: sanitizeProxmoxHints({
                url: parsedUrl.searchParams.get('proxmox_url'),
                username: parsedUrl.searchParams.get('proxmox_username'),
                node: parsedUrl.searchParams.get('proxmox_node'),
              }),
            };
          }
        } catch {
          // Ignore URL parsing failure and fallback to raw code.
        }
      }

      return { pairingCode: raw, serverUrl: normalizedFallbackServer, proxmox: null };
    }

    function _pickFieldValue(currentValue, hintValue, defaultValue) {
      const current = String(currentValue || '').trim();
      const hint = String(hintValue || '').trim();
      const fallback = String(defaultValue || '').trim();
      if (!hint) return current || fallback;
      if (!current || current === fallback) return hint;
      return current;
    }

    function setMessage(text, tone) {
      const msg = $('message');
      msg.textContent = String(text || '');
      msg.className = `inline-status ${tone || ''}`.trim();
    }

    function toFriendlyErrorMessage(raw) {
      const message = String(raw || '').trim();
      if (!message) return 'Operation failed';

      if (/^NETWORK_ERROR:/i.test(message)) {
        return 'Cannot reach Bot-Mox server. Check Server URL and that the stack is running (prod-sim: http://localhost, dev: http://localhost:3001).';
      }

      if (/http\s*401|authentication failed|access denied|invalid credentials|login failed/i.test(message)) {
        return 'Authentication failed. Possible wrong Proxmox username or password.';
      }

      if (/self.?signed|certificate|tls|ssl/i.test(message)) {
        return 'TLS certificate check failed. Verify Proxmox HTTPS certificate or trust settings.';
      }

      if (/timed out|timeout|econnrefused|enotfound|network/i.test(message)) {
        return 'Cannot reach Proxmox endpoint. Check URL, port, and network connectivity.';
      }

      return message;
    }

    function refreshPasswordHint() {
      const hint = $('passwordHint');
      const hasTypedPassword = String($('proxmoxPassword').value || '').trim().length > 0;
      const selectedTargetId = getSelectedTargetId();
      const selectedTarget = selectedTargetId ? state.targetsById[selectedTargetId] : null;
      hint.textContent = hasTypedPassword
        ? 'Password is visible here and will be stored encrypted locally.'
        : selectedTarget?.hasPassword
          ? 'Saved password exists for this computer. It can be loaded and edited here.'
          : 'Password is stored encrypted on this device.';
      hint.className = 'hint';
      $('proxmoxPassword').placeholder = 'Enter Proxmox password';
    }

    function startNewComputer() {
      $('targetSelect').value = '';
      state.activeTargetId = '';
      $('proxmoxUrl').value = '';
      $('proxmoxUsername').value = defaults.proxmoxUsername;
      $('proxmoxNode').value = defaults.proxmoxNode;
      $('proxmoxPassword').value = '';
      setPasswordVisibility(false);
      refreshPasswordHint();
      setMessage('New computer mode. Fill Proxmox fields and click Save Computer.', '');
      $('proxmoxUrl').focus();
    }

    function setPasswordVisibility(visible) {
      const passwordInput = $('proxmoxPassword');
      const toggleBtn = $('togglePasswordBtn');
      const shouldShow = Boolean(visible);
      passwordInput.type = shouldShow ? 'text' : 'password';
      toggleBtn.classList.toggle('is-active', shouldShow);
      toggleBtn.setAttribute('aria-label', shouldShow ? 'Hide password' : 'Show password');
    }

    function togglePasswordVisibility() {
      const passwordInput = $('proxmoxPassword');
      const isMasked = passwordInput.type === 'password';
      setPasswordVisibility(isMasked);
    }

    function setAccountPasswordVisibility(visible) {
      const passwordInput = $('accountPassword');
      const toggleBtn = $('toggleAccountPasswordBtn');
      const shouldShow = Boolean(visible);
      passwordInput.type = shouldShow ? 'text' : 'password';
      toggleBtn.classList.toggle('is-active', shouldShow);
      toggleBtn.setAttribute('aria-label', shouldShow ? 'Hide password' : 'Show password');
    }

    function toggleAccountPasswordVisibility() {
      const passwordInput = $('accountPassword');
      const isMasked = passwordInput.type === 'password';
      setAccountPasswordVisibility(isMasked);
    }

    async function testProxmoxConnection() {
      const btn = $('testProxmoxBtn');
      btn.disabled = true;
      btn.textContent = 'Testing...';
      setMessage('', '');

      try {
        const result = await window.agentApi.testProxmox({
          targetId: getSelectedTargetId() || undefined,
          proxmoxUrl: String($('proxmoxUrl').value || '').trim(),
          proxmoxUsername: String($('proxmoxUsername').value || '').trim(),
          proxmoxPassword: String($('proxmoxPassword').value || ''),
          proxmoxNode: String($('proxmoxNode').value || '').trim(),
        });

        if (result?.success) {
          setMessage('Proxmox connection OK.', 'success');
          refreshPasswordHint();
          return;
        }

        setMessage(toFriendlyErrorMessage((result?.error) || 'Proxmox connection failed'), 'error');
      } catch (err) {
        setMessage(toFriendlyErrorMessage(String(err)), 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Proxmox Connection';
      }
    }

    async function saveComputerTarget() {
      const btn = $('saveTargetBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      setMessage('', '');

      try {
        const result = await window.agentApi.saveProxmoxTarget({
          targetId: getSelectedTargetId() || undefined,
          proxmoxUrl: String($('proxmoxUrl').value || '').trim(),
          proxmoxUsername: String($('proxmoxUsername').value || '').trim(),
          proxmoxPassword: String($('proxmoxPassword').value || ''),
          proxmoxNode: String($('proxmoxNode').value || '').trim(),
        });

        if (result?.success) {
          const cfg = await window.agentApi.getConfig();
          setTargets(cfg.proxmoxTargets || [], cfg.activeTargetId || '');
          if (result.targetId && state.targetsById[result.targetId]) {
            $('targetSelect').value = result.targetId;
            applySelectedTargetToForm(result.targetId);
            const target = state.targetsById[result.targetId];
            if (target && typeof target.password === 'string') {
              $('proxmoxPassword').value = target.password;
              setPasswordVisibility(Boolean(String(target.password || '').trim()));
            }
          }
          refreshPasswordHint();
          setMessage('Computer saved locally. You can switch it in the web app.', 'success');
          return;
        }

        setMessage(toFriendlyErrorMessage((result?.error) || 'Failed to save computer'), 'error');
      } catch (err) {
        setMessage(toFriendlyErrorMessage(String(err)), 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Computer';
      }
    }

    async function submitPairing() {
      const btn = $('pairBtn');
      const accountLogin = String($('accountLogin').value || '').trim();
      const accountPassword = String($('accountPassword').value || '');
      const canUseAccountPairing = Boolean(accountLogin && accountPassword);

      const data = {
        // Server URL is resolved by the main process from saved config / env / defaults.
        serverUrl: '',
        targetId: getSelectedTargetId() || undefined,
        proxmoxUrl: String($('proxmoxUrl').value || '').trim() || defaults.proxmoxUrl,
        proxmoxUsername: String($('proxmoxUsername').value || '').trim() || defaults.proxmoxUsername,
        proxmoxPassword: String($('proxmoxPassword').value || ''),
        proxmoxNode: String($('proxmoxNode').value || '').trim() || defaults.proxmoxNode,
      };

      if (!canUseAccountPairing) {
        setMessage('Enter Bot-Mox account credentials.', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Pairing...';
      setMessage('', '');

      try {
        const result = await window.agentApi.quickPair({
          serverUrl: data.serverUrl,
          login: accountLogin,
          password: accountPassword,
          targetId: data.targetId,
          proxmoxUrl: data.proxmoxUrl,
          proxmoxUsername: data.proxmoxUsername,
          proxmoxPassword: data.proxmoxPassword,
          proxmoxNode: data.proxmoxNode,
        });
        if (result?.success) {
          setMessage('Paired successfully. Agent is starting...', 'success');
          return;
        }

        setMessage(toFriendlyErrorMessage((result?.error) || 'Pairing failed'), 'error');
      } catch (err) {
        setMessage(toFriendlyErrorMessage(String(err)), 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Pair Agent';
      }
    }

    window.agentApi.getConfig().then((cfg) => {
      $('proxmoxUrl').value = cfg.proxmoxUrl || defaults.proxmoxUrl;
      $('proxmoxUsername').value = cfg.proxmoxUsername || defaults.proxmoxUsername;
      $('proxmoxNode').value = cfg.proxmoxNode || defaults.proxmoxNode;
      $('proxmoxPassword').value = String(cfg.proxmoxPassword || '');
      setPasswordVisibility(Boolean(String(cfg.proxmoxPassword || '').trim()));
      setTargets(cfg.proxmoxTargets || [], cfg.activeTargetId || '');
      if (getSelectedTargetId()) {
        applySelectedTargetToForm(getSelectedTargetId());
      }
      refreshPasswordHint();
    });

    $('pairBtn').addEventListener('click', submitPairing);
    $('testProxmoxBtn').addEventListener('click', testProxmoxConnection);
    $('saveTargetBtn').addEventListener('click', saveComputerTarget);
    $('newTargetBtn').addEventListener('click', startNewComputer);
    $('togglePasswordBtn').addEventListener('click', togglePasswordVisibility);
    $('toggleAccountPasswordBtn').addEventListener('click', toggleAccountPasswordVisibility);
    $('targetSelect').addEventListener('change', () => {
      const selectedTargetId = getSelectedTargetId();
      if (applySelectedTargetToForm(selectedTargetId)) {
        const target = state.targetsById[selectedTargetId];
        if (target && typeof target.password === 'string') {
          $('proxmoxPassword').value = target.password;
          setPasswordVisibility(Boolean(String(target.password || '').trim()));
        }
      }
      refreshPasswordHint();
    });
    ['proxmoxUrl', 'proxmoxUsername', 'proxmoxNode'].forEach((id) => {
      $(id).addEventListener('input', () => {
        $('targetSelect').value = '';
      });
    });
    $('proxmoxPassword').addEventListener('input', refreshPasswordHint);

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        submitPairing();
      }
    });
  </script>
</body>
</html>
